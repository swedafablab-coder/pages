---
import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Pagination from "../../components/Pagination.astro";

const POSTS_PER_PAGE = 5;

export async function getStaticPaths() {
  const posts = await getCollection("blog");

  const uniqueArchives = [
    ...new Set(
      posts.map((post) => {
        const date = new Date(post.data.pubDate);
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
      })
    ),
  ];

  return uniqueArchives.map((archive) => ({
    params: { archive },
  }));
}
const { archive } = Astro.params;

const allPosts = (await getCollection("blog"))
  .filter((post) => {
    const date = new Date(post.data.pubDate);
    const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
    return yearMonth === archive;
  })
  .sort(
    (a, b) =>
      new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
  );

const currentPage = 1;
const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);
const paginatedPosts = allPosts.slice(0, POSTS_PER_PAGE);

const toJSTParts = (d: Date | string) => {
  const base = new Date(d);
  const jst = new Date(
    base.toLocaleString("en-US", { timeZone: "Asia/Tokyo" })
  );
  const y = jst.getFullYear();
  const m = String(jst.getMonth() + 1).padStart(2, "0");
  const dd = String(jst.getDate()).padStart(2, "0");
  return { y, m, dd };
};
---

<Layout title={`アーカイブ: ${archive}`} titleSuffix={archive}>
  <ul>
    {
      await Promise.all(
        paginatedPosts.map(async (post) => {
          const { Content } = await render(post);
          const { y, m, dd } = toJSTParts(post.data.pubDate);
          return (
            <li>
              <div class="date">
                <p>記録日：{`${y}年${m}月${dd}日`}</p>
              </div>
              <article>
                <h1>{post.data.title}</h1>
                <Content />
                <nav class="post-nav">
                  <div class="left">
                    <a href={`/blog/${post.slug}/`}>表示</a>
                  </div>
                  <div class="right">
                    <span>カテゴリ:</span>
                    {
                      post.data.category && post.data.category !== "" ? (
                        <>
                          <a href={`/category/${post.data.category}/`}>
                            {post.data.category}
                          </a>{" "}
                          /
                        </>
                      ) : (
                        <>
                          - /
                        </>
                      )
                    }
                    <span>タグ:</span>
                    {
                      (() => {
                        const validTags = (post.data.tags ?? []).filter(
                          (t) => t && t !== "",
                        );
                        return validTags.length > 0 ? (
                          validTags.map((t, i) => (
                            <>
                              <a href={`/tag/${t}/`}>{t}</a>
                              {i < validTags.length - 1 ? ", " : ""}
                            </>
                          ))
                        ) : (
                          <>
                            -
                          </>
                        );
                      })()
                    }
                  </div>
                </nav>
              </article>
            </li>
          );
        })
      )
    }
  </ul>

  <Pagination
    currentPage={currentPage}
    totalPages={totalPages}
    baseUrl={`/archive/${archive}/`}
  />
</Layout>
