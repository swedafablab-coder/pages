---
import { getCollection, render } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import Pagination from "../../../components/Pagination.astro";

const POSTS_PER_PAGE = 5;

export async function getStaticPaths() {
  // getStaticPaths スコープ内で定数を定義
  const POSTS_PER_PAGE = 5;
  const posts = await getCollection("blog");

  // すべてのタグを重複なく取得
  const uniqueTags = [...new Set(posts.flatMap((p) => p.data.tags ?? []))].filter(tag => tag && tag !== "");

  const paths = [];
  // 各タグに対してページを生成
  for (const tag of uniqueTags) {
    const tagPosts = posts.filter((p) => (p.data.tags ?? []).includes(tag));
    const totalPages = Math.ceil(tagPosts.length / POSTS_PER_PAGE);

    for (let i = 1; i <= totalPages; i++) {
      paths.push({ params: { tag, page: String(i) } });
    }
  }

  return paths;
}

const { tag, page } = Astro.params;
const currentPage = Number(page) || 1;

const allPosts = (await getCollection("blog"))
  .filter((post) => (post.data.tags ?? []).includes(tag))
  .sort(
    (a, b) =>
      new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
  );

const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);
const start = (currentPage - 1) * POSTS_PER_PAGE;
const end = start + POSTS_PER_PAGE;
const paginatedPosts = allPosts.slice(start, end);

const toJSTParts = (d: Date | string) => {
  const base = new Date(d);
  const jst = new Date(
    base.toLocaleString("en-US", { timeZone: "Asia/Tokyo" })
  );
  const y = jst.getFullYear();
  const m = String(jst.getMonth() + 1).padStart(2, "0");
  const dd = String(jst.getDate()).padStart(2, "0");
  return { y, m, dd };
};
---

<Layout title={`タグ: ${tag}`} titleSuffix={tag}>
  <ul>
    {
      await Promise.all(
        paginatedPosts.map(async (post) => {
          const { Content } = await render(post);
          const { y, m, dd } = toJSTParts(post.data.pubDate);
          return (
            <li>
              <div class="date">
                <p>記録日：{`${y}年${m}月${dd}日`}</p>
              </div>
              <article>
                <h1>{post.data.title}</h1>
                <Content />
                <nav class="post-nav">
                  <div class="left">
                    <a href={`/blog/${post.slug}/`}>表示</a>
                  </div>
                  <div class="right">
                    <span>カテゴリ:</span>
                    {
                      post.data.category && post.data.category !== "" ? (
                        <>
                          <a href={`/category/${post.data.category}/`}>
                            {post.data.category}
                          </a>{" "}
                          /
                        </>
                      ) : (
                        <>
                          - /
                        </>
                      )
                    }
                    <span>タグ:</span>
                    {
                      (() => {
                        const validTags = (post.data.tags ?? []).filter(
                          (t) => t && t !== "",
                        );
                        return validTags.length > 0 ? (
                          validTags.map((t, i) => (
                            <>
                              <a href={`/tag/${t}/`}>{t}</a>
                              {i < validTags.length - 1 ? ", " : ""}
                            </>
                          ))
                        ) : (
                          <>
                            -
                          </>
                        );
                      })()
                    }
                  </div>
                </nav>
              </article>
            </li>
          );
        })
      )
    }
  </ul>

  <Pagination
    currentPage={currentPage}
    totalPages={totalPages}
    baseUrl={`/tag/${tag}/`}
  />
</Layout>
