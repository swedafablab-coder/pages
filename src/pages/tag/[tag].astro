---
import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Pagination from "../../components/Pagination.astro";

const POSTS_PER_PAGE = 5;

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tags = [...new Set(posts.flatMap((post) => post.data.tags ?? []))].filter(tag => tag && tag !== "");
  return tags.map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;

const allPosts = (await getCollection("blog"))
  .filter((post) => (post.data.tags ?? []).includes(tag))
  .sort(
    (a, b) =>
      new Date(a.data.pubDate).getTime() - new Date(b.data.pubDate).getTime()
  );

const url = new URL(Astro.request.url);
const currentPage = Number(url.searchParams.get("page")) || 1;

const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);
const start = (currentPage - 1) * POSTS_PER_PAGE;
const end = start + POSTS_PER_PAGE;
const paginatedPosts = allPosts.toReversed().slice(start, end);

const toJSTParts = (d: Date | string) => {
  const base = new Date(d);
  const jst = new Date(
    base.toLocaleString("en-US", { timeZone: "Asia/Tokyo" })
  );
  const y = jst.getFullYear();
  const m = String(jst.getMonth() + 1).padStart(2, "0");
  const dd = String(jst.getDate()).padStart(2, "0");
  return { y, m, dd };
};
---

<Layout title={`タグ: ${Astro.params.tag}`} titleSuffix={Astro.params.tag}>
  <ul>
    {
      await Promise.all(
        allPosts.toReversed().map(async (post: any) => {
          const { Content } = await render(post);
          const { y, m, dd } = toJSTParts(post.data.pubDate);
          return (
            <li>
              <div class="date">
                <p>記録日：{`${y}年${m}月${dd}日`}</p>
              </div>
              <article>
                <h1>{post.data.title}</h1>
                <Content />
                <nav class="post-nav">
                  <div class="left">
                    <a href={`/blog/${post.slug}/`}>表示</a>
                  </div>
                  <div class="right">
                    <span>カテゴリ:</span>
                    {
                      post.data.category && post.data.category !== "" ? (
                        <>
                          <a href={`/category/${post.data.category}/`}>
                            {post.data.category}
                          </a>{" "}
                          /
                        </>
                      ) : (
                        <>
                          - /
                        </>
                      )
                    }
                    <span>タグ:</span>
                    {
                      (() => {
                        const validTags = (post.data.tags ?? []).filter(
                          (t: any) => t && t !== "",
                        );
                        return validTags.length > 0 ? (
                          validTags.map((t: any, i: number) => (
                            <>
                              <a href={`/tag/${t}/`}>{t}</a>
                              {i < validTags.length - 1 ? ", " : ""}
                            </>
                          ))
                        ) : (
                          <>
                            -
                          </>
                        );
                      })()
                    }
                  </div>
                </nav>
              </article>
            </li>
          );
        })
      )
    }
  </ul>
  <Pagination
    currentPage={currentPage}
    totalPages={totalPages}
    baseUrl={`/tag/${tag}/`}
  />
</Layout>
