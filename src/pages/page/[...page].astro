---
import { getCollection, render } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Pagination from "../../components/Pagination.astro";

function toJSTParts(dateString: string | Date) {
  const date = new Date(dateString);
  const y = date.getFullYear();
  const m = date.getMonth() + 1;
  const dd = date.getDate();
  return { y, m, dd };
}

export async function getStaticPaths() {
  const POSTS_PER_PAGE = 5;
  const posts = await getCollection("blog");
  const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);

  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
  }));
}
const POSTS_PER_PAGE = 5;
const posts = (await getCollection("blog"))
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());
const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);
const currentPage = Number(Astro.params.page ?? "1");
const start = (currentPage - 1) * POSTS_PER_PAGE;
const end = start + POSTS_PER_PAGE;
const paginatedPosts = posts.slice(start, end);
const title = `${currentPage}ページ目`;

---
<Layout title={title}>
  <ul>
    {
      await Promise.all(
        paginatedPosts.map(async (post) => {
          const { Content } = await render(post);
          const { y, m, dd } = toJSTParts(post.data.pubDate);
          return (
            <li>
              <div class="date">
                <p>記録日：{`${y}年${m}月${dd}日`}</p>
              </div>
              <article>
                <h1>{post.data.title}</h1>
                <Content />
                <nav class="post-nav">
                  <div class="left">
                    <a href={`/blog/${post.slug}/`}>表示</a>
                  </div>
                  <div class="right">
                    <span>カテゴリ:</span>
                    {
                      post.data.category && post.data.category !== "" ? (
                        <>
                          <a href={`/category/${post.data.category}/`}>
                            {post.data.category}
                          </a>{" "}
                          /
                        </>
                      ) : (
                        <>
                          - /
                        </>
                      )
                    }
                    <span>タグ:</span>
                    {
                      (() => {
                        const validTags = (post.data.tags ?? []).filter(
                          (t) => t && t !== "",
                        );
                        return validTags.length > 0 ? (
                          validTags.map((t, i) => (
                            <>
                              <a href={`/tag/${t}/`}>{t}</a>
                              {i < validTags.length - 1 ? ", " : ""}
                            </>
                          ))
                        ) : (
                          <>
                            -
                          </>
                        );
                      })()
                    }
                  </div>
                </nav>
              </article>
            </li>
          );
        })
      )
    }
  </ul>

  <Pagination
    currentPage={currentPage}
    totalPages={totalPages}
    baseUrl="/page/"
  />
</Layout>
